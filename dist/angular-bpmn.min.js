"use strict";angular.module("angular-bpmn",[]),angular.module("angular-bpmn").run(["$rootScope",function(t){return function(t){return t.runMode="debug"}}(this)]),angular.module("angular-bpmn").service("log",["$log","$rootScope",function(t,e){return{debug:function(){return"debug"===e.runMode?t.debug.apply(self,arguments):void 0},error:function(){return t.error.apply(self,arguments)}}}]),angular.module("angular-bpmn").service("bpmnMock",function(){return{scheme1:{name:"",description:"",objects:[{id:1,type:{name:"event",start:{0:{0:!0}}},position:{top:80,left:50},status:"",error:"",title:"start event",description:""},{id:2,type:{name:"task",status:"",action:""},position:{top:60,left:260},status:"",error:"",title:"task",description:""},{id:3,type:{name:"event",end:{simply:{top_level:!0}}},position:{top:80,left:530},status:"",error:"",title:"end event",description:""}],connectors:[{id:1,start:{object:1,point:1},end:{object:2,point:10},flow_type:"default",title:"connector №1"},{id:2,start:{object:2,point:4},end:{object:3,point:3},flow_type:"default",title:"connector №2"}]}}}),angular.module("angular-bpmn").directive("bpmnObject",["log","$timeout","$templateCache","$compile","$templateRequest","$q",function(t,e,n,o,r,s){return{restrict:"A",controller:["$scope","$element",function(t,e){var n,o;return n=$(e),"poster"===t.data.type.name&&n.find("img").on("dragstart",function(t){return t.preventDefault()}),o=function(){var e;return e={top:t.data.position.top,left:t.data.position.left},n.css(e),t.instance.repaintEverything()},t.$watch("data.position",function(t,e){return t!==e?o():void 0}),o()}],link:function(t,e,n){}}}]),angular.module("angular-bpmn").factory("bpmnObjectFact",["bpmnSettings","$compile","$rootScope","log","$templateRequest","$templateCache",function(t,e,n,o,r,s){var a;return a=function(){function a(e,n){var r;o.debug("object construct"),this.parentScope=n,this.settings=n.settings,this.data=e,r=t.template(e.type.name),this.anchor=r.anchor,this.size=r.size,this.make=r.make,this.draggable=r.draggable,this.templateUrl=r.templateUrl||null,this.template=r.template||null,this.templateUpdate()}return a.prototype.isDebug=!0,a.prototype.parentScope=null,a.prototype.data=null,a.prototype.anchor=null,a.prototype.make=null,a.prototype.draggable=null,a.prototype.templateUrl=null,a.prototype.template=null,a.prototype.element=null,a.prototype.container=null,a.prototype.size=null,a.prototype.points=null,a.prototype.templateUpdate=function(){var t,a,i,c;return a=n.$new(),a.data=this.data,a.instance=this.parentScope.instance,a.object=this,t=function(t){return function(e){return t.element.empty().append(e)}}(this),null!=this.templateUrl&&""!==this.templateUrl?(null==this.element&&(this.element=e('<div bpmn-object class="'+this.data.type.name+' draggable etc" ng-class="[data.status]"></div>')(a)),c=this.settings.theme.root_path+"/"+this.settings.engine.theme+"/"+this.templateUrl,i=s.get(c),null==i?(o.debug("template not found",c),this.elementPromise=r(c),this.elementPromise.then(function(n){return t(e(n)(a)),s.put(c,n)})):t(e(i)(a))):null==this.element?this.element=e(this.template)(a):void 0},a.prototype.generateAnchor=function(t){var e;if(this.anchor&&0!==this.anchor.length)return this.element?(e=[],angular.forEach(this.anchor,function(n){return function(o){var r;return r=n.parentScope.instance.addEndpoint(n.element,{anchor:o,maxConnections:-1},t),-1===e.indexOf(r)?e.push(r):void 0}}(this)),this.points=e):void o.debug("generateAnchor: @element is null",this)},a.prototype.appendTo=function(t,e){return this.element&&""!==this.element?(this.container=t,t.append(this.element),this.size?$(this.element).css({width:this.size.width,height:this.size.height}):o.error("@size is null, element:",this.element),this.generateAnchor(e)):void o.debug("appendTo: @element is null",this)},a.prototype.select=function(t){},a}()}]);var LEFT_MB,MIDDLE_MB,RIGHT_MB;LEFT_MB=1,MIDDLE_MB=2,RIGHT_MB=3,angular.module("angular-bpmn").factory("bpmnScheme",["$rootScope","log","bpmnUuid","$compile","bpmnSettings","$templateCache","$templateRequest","$q","$timeout","bpmnObjectFact",function(t,e,n,o,r,s,a,i,c,p){var l;return l=function(){function l(e,o){var r;this.id=n.gen(),this.container=e,r=e.parent("."+this.wrap_class),0===r.length&&e.wrap('<div class="'+this.wrap_class+'"></div>'),this.wrapper=e.parent("."+this.wrap_class),preventSelection(document),this.scope=t.$new(),this.scope.extScheme={},this.scope.intScheme={objects:{},connectors:[]},this.scope.settings={},this.scope.selected=[],this.scope.zoom=1,this.setSettings(o),this.wrapper.append('<div class="page-loader"><div class="spinner">loading...</div></div>')}return l.prototype.isDebug=!0,l.prototype.isStarted=!1,l.prototype.id=null,l.prototype.scope=null,l.prototype.container=null,l.prototype.wrapper=null,l.prototype.cache=null,l.prototype.style_id="bpmn-style-theme",l.prototype.wrap_class="bpmn-wrapper",l.prototype.schemeWatch=null,l.prototype.setStatus=function(){return"editor"===this.scope.settings.engine.status?this.container.addClass("editor"):this.container.addClass("viewer")},l.prototype.setScheme=function(t){return null==t&&(t=this.scope.extScheme||{}),this.scope.extScheme=t},l.prototype.setSettings=function(t){return null==t&&(t={}),this.scope.settings=$.extend(!0,r,angular.copy(t))},l.prototype.loadStyle=function(){var t,n,o;return o=this.scope.settings.engine.theme,t=this.scope.settings.theme.root_path+"/"+o+"/style.css",n=$("link#"+this.style_id+"-"+o),0===n.length?$("<link/>",{rel:"stylesheet",href:t,id:this.style_id+"-"+o}).appendTo("head"):n.attr("href",t),e.debug("load style file:",t),this.wrapper.removeClass(),this.wrapper.addClass(this.wrap_class+" "+o)},l.prototype.cacheTemplates=function(){return angular.forEach(this.scope.settings.templates,function(t){return function(n){var o,r,i;if(null!=n.templateUrl&&""!==n.templateUrl)return i=t.scope.settings.theme.root_path+"/"+t.scope.settings.engine.theme+"/"+n.templateUrl,o=s.get(i),null==o?(r=a(i),t.cache.push(r),r.then(function(t){return e.debug("load template file:",i),s.put(i,t)})):void 0}}(this))},l.prototype.makePackageObjects=function(){var t;return e.debug("make package objects"),t=[],angular.forEach(this.scope.extScheme.objects,function(e){return function(n){var o;return o=new p(n,e.scope),e.scope.intScheme.objects[n.id]=o,t.push(o.elementPromise)}}(this)),i.all(t).then(function(t){return function(){return angular.forEach(t.scope.intScheme.objects,function(e){return e.appendTo(t.container,t.scope.settings.point),t.scope.instance.off(e.element),t.scope.instance.on(e.element,"click",function(){return t.scope.selected=[],t.scope.$apply(t.scope.selected.push(e.data.id)),t.deselectAll(),e.select(!0)})}),t.instanceBatch(),t.connectPackageObjects(),t.isStarted=!0,t.wrapper.find(".page-loader").fadeOut("slow")}}(this))},l.prototype.instanceBatch=function(){return this.scope.instance.batch(function(t){return function(){return e.debug("instance batch"),"editor"===t.scope.settings.engine.status?t.scope.instance.draggable(t.container.find(".etc"),t.scope.settings.draggable):void 0}}(this))},l.prototype.connectPackageObjects=function(){var t;if(null!=(null!=(t=this.scope.extScheme)?t.connectors:void 0))return e.debug("connect package objects"),angular.forEach(this.scope.extScheme.connectors,function(t){return function(n){var o,r,s;if(n.start&&n.end&&t.scope.intScheme.objects[n.start.object]&&t.scope.intScheme.objects[n.end.object]&&t.scope.intScheme.objects[n.start.object].points&&t.scope.intScheme.objects[n.end.object].points)return r={},s={},angular.forEach(t.scope.intScheme.objects,function(t){return t.data.id===n.start.object&&(r=t.points),t.data.id===n.end.object?s=t.points:void 0}),null==r[n.start.point]?void e.error("connect: source not found",t):null==s[n.end.point]?void e.error("connect: target not found",t):(o={sourceEndpoint:r[n.start.point],targetEndpoint:s[n.end.point]},n.title&&""!==n.title&&(o.overlays=[["Label",{label:n.title,cssClass:"aLabel"},{id:"myLabel"}]]),t.scope.intScheme.connectors.push(t.scope.instance.connect(o,t.scope.settings.connector)))}}(this))},l.prototype.addObject=function(t){},l.prototype.removeObject=function(t){},l.prototype.deselectAll=function(){return angular.forEach(this.scope.intScheme.objects,function(t){return t.select(!1)})},l.prototype.panning=function(){var t,e,n;return n=o('<div class="panning-cross"> <svg> <g id="layer1" transform="translate(-291.18256,-337.29837)"> <path id="path3006" stroke-linejoin="miter" d="m331.14063,340.36763,0,29.99702" stroke="#000" stroke-linecap="butt" stroke-miterlimit="4" stroke-dasharray="none" stroke-width="2.01302433"/> <path id="path3008" stroke-linejoin="miter" d="m316.11461,355.29379,30.24144,0" stroke="#000" stroke-linecap="butt" stroke-miterlimit="4" stroke-dasharray="none" stroke-width="2"/> </g> </svg> <div class="zoom-info">({{zoom}})</div> </div>')(this.scope),this.container.append(n),$(n).css({position:"absolute",top:-23,left:-45}),e={x:0,y:0,state:!1},t={x:0,y:0},this.wrapper.on("mousedown",function(t){return $(t.target).hasClass("ui-resizable-handle")?void 0:e.state||t.which!==LEFT_MB?void 0:(e.x=t.pageX,e.y=t.pageY,e.state=!0)}),this.wrapper.on("mousemove",function(n){return function(o){var r;return e.state?(t.x=o.pageX-e.x,t.y=o.pageY-e.y,r=n.container.offset(),n.container.offset({left:r.left+t.x,top:r.top+t.y}),e.x=o.pageX,e.y=o.pageY):void 0}}(this)),this.wrapper.on("mouseup",function(t){return e.state?e.state=!1:void 0}),this.wrapper.on("contextmenu",function(t){return!1}),this.wrapper.on("mouseleave",function(t){return e.state?e.state=!1:void 0}),this.wrapper.on("mousewheel",function(t){return function(e){return e.preventDefault(),t.scope.zoom+=.1*e.deltaY,t.scope.zoom=parseFloat(t.scope.zoom.toFixed(1)),t.scope.zoom<.1?t.scope.zoom=.1:t.scope.zoom>2&&(t.scope.zoom=2),t.scope.instance.setZoom(t.scope.zoom),t.scope.instance.repaintEverything(t.scope.zoom),c(function(){return t.scope.$apply(t.scope.zoom)},0),t.container.css({"-webkit-transform":t.scope.zoom,"-moz-transform":"scale("+t.scope.zoom+")","-ms-transform":"scale("+t.scope.zoom+")","-o-transform":"scale("+t.scope.zoom+")",transform:"scale("+t.scope.zoom+")"})}}(this))},l.prototype.start=function(){var t;return e.debug("start"),this.panning(),this.loadStyle(),this.scope.instance=jsPlumb.getInstance($.extend(!0,this.scope.settings.instance,{Container:this.container})),this.cache=[],this.cacheTemplates(),this.container.addClass("bpmn"),this.setStatus(),this.schemeWatch&&this.schemeWatch(),this.schemeWatch=this.scope.$watch("extScheme",function(t){return function(e,n){return e!==n?t.restart():void 0}}(this)),i.all(this.cache).then(function(t){return function(){return t.makePackageObjects()}}(this)),null!=(null!=(t=this.scope.settings.engine.container)?t.resizable:void 0)&&this.wrapper.resizable({minHeight:200,minWidth:400,grid:10,handles:"s",start:function(){},resize:function(){}}),this.scope.$on("$routeChangeSuccess",function(t){return function(){return t.destroy()}}(this))},l.prototype.destroy=function(){return e.debug("destroy"),this.wrapper.find(".page-loader").fadeIn("slow"),this.schemeWatch&&this.schemeWatch(),this.wrapper.off("mousedown"),this.wrapper.off("mousemove"),this.wrapper.off("mouseup"),this.wrapper.off("contextmenu"),this.wrapper.off("mousewheel")},l.prototype.restart=function(){return e.debug("restart"),null!=this.isStarted&&this.destry(),this.start()},l}()}]),angular.module("angular-bpmn").service("bpmnSettings",function(){var t,e,n,o,r,s,a,i,c,p,l,u;return u={root_path:"/themes",list:["default","minimal"]},r={theme:"minimal",status:"viewer",container:{resizable:!0}},s={DragOptions:{cursor:"pointer",zIndex:20},ConnectionOverlays:[["Arrow",{location:1,id:"arrow",width:12,length:12,foldback:.8}]],Container:"container"},o={filter:".ui-resizable-handle",grid:[5,5],drag:function(t,e){}},n={strokeStyle:"#000000",lineWidth:2,outlineWidth:4},a={isSource:!0,isTarget:!0,endpoint:["Dot",{radius:1}],maxConnections:-1,paintStyle:{outlineWidth:1},hoverPaintStyle:{},connectorStyle:n},t=["Flowchart",{cornerRadius:0,midpoint:.5,minStubLength:10,stub:[30,30],gap:0}],e={connector:t,isSource:!0,isTarget:!0},i={filter:".ep",anchor:[],connector:t,connectorStyle:n,endpoint:["Dot",{radius:1}],maxConnections:-1,onMaxConnections:function(t,e){return alert("Maximum connections ("+t.maxConnections+") reached")}},c={anchor:[],endpoint:["Dot",{radius:1}],allowLoopback:!1,uniqueEndpoint:!0,isTarget:!0,maxConnections:-1},l={event:{templateUrl:"event.svg",anchor:[[.52,.05,0,-1,0,2],[1,.52,1,0,-2,0],[.52,1,0,1,0,-2],[.1,.52,-1,0,2,0]],make:["source","target"],draggable:!0,size:{width:50,height:50}},task:{templateUrl:"task.svg",anchor:[[.25,.04,0,-1,0,2],[.5,.04,0,-1,0,2],[.75,.04,0,-1,0,2],[.97,.25,1,0,-2,0],[.97,.5,1,0,-2,0],[.97,.75,1,0,-2,0],[.75,.97,0,1,0,-2],[.5,.97,0,1,0,-2],[.25,.97,0,1,0,-2],[.04,.75,-1,0,2,0],[.04,.5,-1,0,2,0],[.04,.25,-1,0,2,0]],make:["source","target"],draggable:!0,size:{width:112,height:92}},gateway:{templateUrl:"gateway.svg",anchor:[[.5,0,0,-1,0,2],[1,.5,1,0,-2,0],[.5,1,0,1,0,-2],[0,.5,-1,0,2,0]],make:["source","target"],draggable:!0,size:{width:52,height:52}},group:{template:'<div bpmn-object class="group etc draggable" ng-style="{width: data.width, height: data.height}" ng-class="{ dashed : data.style == \'dashed\', solid : data.style == \'solid\' }"> <div class="title">{{data.title}}</div> </div>',anchor:[],make:[],draggable:!0},swimlane:{template:'<div bpmn-object class="swimlane etc draggable" ng-style="{ width: data.width }"></div>',anchor:[],make:[],draggable:!0},"swimlane-row":{template:'<div bpmn-object class="swimlane-row" ng-style="{width: \'100%\', height: data.height }"> <div class="header"><div class="text">{{data.title}}</div></div> </div>',anchor:[],make:[],draggable:!1},poster:{template:'<div bpmn-object class="poster draggable" ng-class="{ \'etc\' : data.draggable }"><img ng-src="{{data.url}}"></div>',anchor:[],make:[],draggable:!0},"default":{template:'<div bpmn-object class="dummy etc draggable">shape not found</div>',anchor:[[.5,0,0,-1,0,2],[1,.5,1,0,-2,0],[.5,1,0,1,0,-2],[0,.5,-1,0,2,0]],make:["source","target"],draggable:!0,size:{width:40,height:40}}},p=function(t){return null!=l[t]?l[t]:l["default"]},{theme:u,engine:r,instance:s,draggable:o,point:a,connector:e,source:i,target:c,template:p,templates:l}}),angular.module("angular-bpmn").factory("bpmnUuid",function(){var t;return t=function(){function t(){}return t.generator=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e,n,o;return e=(new Date).getTime(),o=(e+16*Math.random())%16|0,e=Math.floor(e/16),n=null,n="x"===t?o:3&o|8,n.toString(16)})},t.gen=function(){return this.generator()},t}()});